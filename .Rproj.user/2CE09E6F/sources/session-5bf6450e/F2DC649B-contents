---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(lubridate)
```

```{r, message=FALSE}
flights_data <- read_csv("data/flights.csv") %>% 
  janitor::clean_names()
airports_data <- read_csv("data/airports.csv") %>% 
  janitor::clean_names()
weather_data <- read_csv("data/weather.csv") %>% 
  janitor::clean_names()
plane_data <- read_csv("data/planes.csv") %>% 
  janitor::clean_names()
```

```{r}
# capture only newark airport flights
newark_flights <- inner_join(flights_data, airports_data, by = c("origin" = "faa")) %>% 
  filter(name == "Newark Liberty International Airport") %>% 
  mutate(date = make_date(year, month, day)) %>% # add date field
  mutate(month_name = month(date, label = TRUE)) # add month name
```

```{r}
# measures of busy-ness in newark flights data
newark_flights <- newark_flights %>% 
  group_by(time_hour) %>% 
  mutate(departures_in_hour = n()) %>% 
  ungroup()

newark_flights <- newark_flights %>% 
  group_by(date) %>% 
  mutate(departures_in_day = n()) %>% 
  ungroup()
```

```{r}
# categorise delay times
# delays less than 15 mins are "on time" according to FAA
newark_flights_delayed <- newark_flights %>% 
  filter(dep_delay > 0) %>% 
  mutate(delay_category = case_when(
    dep_delay > 60 ~ "delay > 1 hr", 
    dep_delay >= 15 ~ "delay <= 1hr", 
    TRUE ~ "delay < 15 mins"
  ))
```

```{r}
newark_flights_delayed %>% 
  group_by(month_name) %>%
  summarise(num_delays = n()) %>% 
  ggplot() +
  aes(x = month_name, y = num_delays) +
  geom_col(fill = "lightblue") + 
  labs(
    x = "", 
    y = "number of delays\n", 
    title = "Newark Airport - number of delayed flights\n"
  ) + 
  theme_grey()
```
```{r}
newark_flights_delayed %>% 
  filter(dep_delay > 15) %>% # don't include delays classed as "on time"
  group_by(month_name) %>%
  ggplot() +
  aes(x = month_name, fill = delay_category) +
  geom_bar(position = "dodge") + 
  # facet_grid(delay_category ~.)
  labs(
    x = "", 
    y = "number of delays\n", 
    title = "Newark Airport - length of delay\n"
  )
```
```{r}
newark_flights_delayed %>% 
  group_by(month_name) %>% 
  summarise(average_delay = mean(dep_delay)) %>% 
  ggplot() +
  aes(x = month_name, y = average_delay) + 
  geom_col(fill = "lightblue") +
  labs(
    x = "", 
    y = "average delay (mins)\n", 
    title = "Newark Airport - average delay length\n")
```

```{r}
newark_weather <- weather_data %>% 
  filter(origin == "EWR")

colSums(is.na(newark_weather))
```
There are 8,700 weather observations relating to Newark Airport in 2017. Of these, most variables had in excess of 8,500 missing values. Only wind data and visibility were sufficiently populated to be of use with the rest being discarded. The wind data each had ~600 missing values (less than 7% of the population) whilst `visibility` had only 3 missing values. The missing values were removed as being immaterial in volume to the population of data. 

Despite an extensive internet search I could not find free access to hourly weather data for Newark Airport to supplement the provided data set. 

```{r}
newark_weather <- newark_weather %>% 
  select(wind_dir, wind_speed, wind_gust, visib) %>% 
  drop_na()


```



