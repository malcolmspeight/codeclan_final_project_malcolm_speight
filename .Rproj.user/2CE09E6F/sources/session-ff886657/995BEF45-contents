---
title: "Newark Flight Data"
author: "Malcolm Speight"
date: "2023-02-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r, include=FALSE}
library(tidyverse)
library(lubridate)
library(ggfortify)
```

```{r, include=FALSE}
flights_data <- read_csv("data/flights.csv") %>% 
  janitor::clean_names()
airports_data <- read_csv("data/airports.csv") %>% 
  janitor::clean_names()
weather_data <- read_csv("data/weather.csv") %>% 
  janitor::clean_names()
plane_data <- read_csv("data/planes.csv") %>% 
  janitor::clean_names()
```

```{r}
# capture only newark airport flights
newark_flights <- inner_join(flights_data, airports_data, by = c("origin" = "faa")) %>% 
  filter(name == "Newark Liberty International Airport") %>% 
  mutate(date = make_date(year, month, day)) %>% # add date field
  mutate(month_name = month(date, label = TRUE)) # add month name
```

```{r}
# categorise delay times
# delays less than 15 mins are "on time" according to FAA
newark_flights_delayed <- newark_flights %>% 
  filter(dep_delay > 0) %>% 
  mutate(delay_category = case_when(
    dep_delay > 60 ~ "> 1 hr", 
    dep_delay >= 15 ~ "<= 1hr", 
    TRUE ~ "< 15 mins"
  ))
```

```{r}
# number of delayed flights at Newark Airport
newark_flights_delayed %>% 
  group_by(month_name) %>%
  summarise(num_delays = n()) %>% 
  ggplot() +
  aes(x = month_name, y = num_delays) +
  geom_col(fill = "lightblue") + 
  labs(
    x = "", 
    y = "number of delays\n", 
    title = "Newark Airport - number of delayed flights\n"
  ) + 
  theme_grey()
```

```{r}
# average flight delay at Newark Airport
newark_flights_delayed %>% 
  group_by(month_name) %>% 
  summarise(average_delay = mean(dep_delay)) %>% 
  ggplot() +
  aes(x = month_name, y = average_delay) + 
  geom_col(fill = "lightblue") +
  labs(
    x = "", 
    y = "average delay (mins)\n", 
    title = "Newark Airport - average flight delay\n") + 
  theme_grey()
```

*Weather*

```{r}
# capture only newark weather
newark_weather <- weather_data %>% 
  filter(origin == "EWR")

colSums(is.na(newark_weather))
```

There are 8,700 weather observations relating to Newark Airport in 2017. Of these, most variables had in excess of 8,500 missing values. Only `wind data` (3 variables) and `visibility` were sufficiently populated to be of use with the rest being discarded. The wind data each had ~600 missing values (less than 7% of the population) whilst `visibility` had only 3 missing values. All the missing values were removed as being immaterial in volume to the population of data.

Despite an extensive internet search I could not find free access to hourly weather data for Newark Airport to supplement the provided data set. 

```{r}
# remove missing values
newark_weather <- newark_weather %>% 
  select(wind_dir, wind_speed, wind_gust, visib, time_hour) %>% 
  drop_na()
```

To investigate the effect of weather on departure delays at Newark Airport we need to combine the data for flight delays at the airport with the corresponding weather data. 

As an initial investigation, I will look to determine if we can explain the scale of flight delay (dependent variable) by the weather conditions (independent variables) prevalent at the time. We will use linear regression to determine if there is a direct relationship between the weather data and the length of flight delay. If so we will be able to quantify the size and strength of this relationship. 
To do begin this process we need only the departure delay (`dep_delay`) from the `newark_flights_delayed` dataset combined with the reamining weather data, joined by the date and hour field (`time_hour`).

```{r}
newark_weather_delays <- newark_flights_delayed %>% 
  select(dep_delay, time_hour) %>% 
  inner_join(newark_weather, by = "time_hour") %>% 
  select(-time_hour)
```

The result is a dataset of 41,296 observations with 5 numeric variables. 

```{r}
glimpse(newark_weather_delays)
```
```{r, message=FALSE}
newark_weather_delays %>% 
  gather() %>% 
  ggplot() +
  geom_histogram(mapping = aes(x = value, fill = key), colour = "black") +
  facet_wrap(~ key, scales = "free") + 
  theme_minimal()
```
The dependent variable (`dep_delay`) is very right-skewed. Most scheduled airline flights take off on-time or if delayed, the delay is not excessive, so we would expect most delays to be at the lower end of the scale. Interestingly, `wind_gust` and `wind_speed` are similarly right-skewed.

Visibility (`visib`) is very left-skewed with the vast majority of observations providing a clear sight for 10 miles. Wind direction (`wind_dir`) is the most normally distributed of all the weather variables. 

The skewness of the variables can be lessened by log transforming the data. I'll look to log transform all of the independent variables except for `wind_dir` which as noted above has a fairly normal distribution. 

```{r}
newark_weather_delays_log <- newark_weather_delays %>% 
  mutate(visib_log = log(visib),
         wind_gust_log = log(wind_gust + 1), # to avoid -Infinity
         wind_speed_log = log(wind_speed + 1)) %>% # to avoid -Infinity
  select(-c("visib", "wind_gust", "wind_speed")) 
```

```{r, message=FALSE, warning=FALSE}
newark_weather_delays_log %>% 
  gather() %>% 
  ggplot() +
  geom_histogram(mapping = aes(x = value, fill = key), colour = "black") +
  facet_wrap(~ key, scales = "free") + 
  theme_minimal()
```
The log of the visibility variable remains skewed left but `wind_gust` and `wind_speed` appear more normally distributed than prior to transformation.

*Correlation*

Correlation measures the strength and direction of the relationship between two linearly related variables (meaning they change together at a constant rate).  

The table below shows the 5 variables from our data set and the correlation coefficients that exist between them. 

A positive value indicates that two variables will move in the same direction as each other. As one increases in value, so does the other. A negative value indicates their values will move in opposite directions. The correlation coefficient has a value in the range -1 to +1 where +/- 1 indicates the strongest possible relationship and 0 indicates no relationship. 

Looking at the `dep_delay` column we can see that the relationship between delays and weather events are very weakly correlated indeed.  

```{r}
cor(newark_weather_delays_log[, c("dep_delay", "wind_dir", 
                                  "wind_speed_log", "wind_gust_log", "visib_log")])
```

*Fitting the multiple linear regression model*

The following command fits a linear regression model that relates the 4 independent/predictor variables from our dataset to the total departure delay (`dep_delay`), the dependent/reponse variable.

```{r}
weather_delays_mod1 <- lm(data = newark_weather_delays_log, dep_delay ~ .)
```

To evaluate how well the model fits our data and how well it explains the values of the dependent variable, we run the `summary` command. 

```{r}
summary(weather_delays_mod1)
```

*Model evaluation*

The `residuals` provide a measure of the error in our model predictions - the residual is equal to the true value less the model predicted value. The maximum error of 1162.97 shows that linear regression under-predicted the departure delay by over 19 hours (19 x 60 mins = 1,140) for at least one observation. This is quite substantial. 

The log of the `wind_dir` and `visib` variables both have a very small `p-value` denoted by Pr(>|t|) and are statistically significant, indicated by the 3-stars (***). This indicates that their coefficients are indicative of a true relationship, rather than just occuring by chance. This is not the case for the log of `wind_gust` or `wind_speed` indicating that these variables can be ignored and removed from the model. 

The regression coefficients (under the `Estimate` column) indicate the estimated change in value in departure delays for a one unit change in each of the predictor variables, assuming all other values are held constant. 

Of the statistically significant variables from the weather dataset, visibility impacts departure delays the most. For each additional increment in the log of `visib`, departure delays will decrease by just over 9 minutes. 

Towards the bottom of the summary table, the Multiple R-squared value provides a measure of how well our model of weather data explains the movement in departure delays. Similar to the correlation coefficient, the closer the R-squared value is to 1.0, the better the model explains the data. Since our model has an R-squared value of 0.00573, this informs us that the model is a very poor predictor as it explains only 0.57% of movement in departure delays. 

From the above indicators, it would appear that weather events have little impact on departure delays at Newark Airport. 

*Validity of regression model*

Assessing the validity of the linear regression requires that:

1. The errors of the model (residuals) are independent of each other.
  - the blue line in the Residuals vs Fitted graph below shows that this condition is true. 

2. The residuals are normally distributed. 
  - the Normal Q-Q plot shows the data points diverging from the dotted line as values increase, highlighting that this assumption may not be satisfied.  
  
3. There is no systematic increase or decrease in variation across the range of data
  - the data points should occur in a fixed width band in the Scale-Location plot. This doesn't appear to hold as the data points funnel towards a point as the fitted values rise in value. 

```{r}
autoplot(weather_delays_mod1)
```

It would appear that a linear regression produces a poor explanation for the movement in departure delays and the residuals from which may not satisfy required conditions for the model to hold. Given these issues it may instead be best to consider if we can identify patterns in the dataset for weather delays at Newark Airport that may not be immediately apparent or explicitly defined. 









