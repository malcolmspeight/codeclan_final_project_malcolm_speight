---
title: "Newark Flight Data"
author: "Malcolm Speight"
date: "2023-02-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r, include=FALSE}
library(tidyverse)
library(lubridate)
```

```{r, include=FALSE}
flights_data <- read_csv("data/flights.csv") %>% 
  janitor::clean_names()
airports_data <- read_csv("data/airports.csv") %>% 
  janitor::clean_names()
weather_data <- read_csv("data/weather.csv") %>% 
  janitor::clean_names()
plane_data <- read_csv("data/planes.csv") %>% 
  janitor::clean_names()
```

```{r}
# capture only newark airport flights
newark_flights <- inner_join(flights_data, airports_data, by = c("origin" = "faa")) %>% 
  filter(name == "Newark Liberty International Airport") %>% 
  mutate(date = make_date(year, month, day)) %>% # add date field
  mutate(month_name = month(date, label = TRUE)) # add month name
```

```{r}
# categorise delay times
# delays less than 15 mins are "on time" according to FAA
newark_flights_delayed <- newark_flights %>% 
  filter(dep_delay > 0) %>% 
  mutate(delay_category = case_when(
    dep_delay > 60 ~ "> 1 hr", 
    dep_delay >= 15 ~ "<= 1hr", 
    TRUE ~ "< 15 mins"
  ))
```

```{r}
# number of delayed flights at Newark Airport
newark_flights_delayed %>% 
  group_by(month_name) %>%
  summarise(num_delays = n()) %>% 
  ggplot() +
  aes(x = month_name, y = num_delays) +
  geom_col(fill = "lightblue") + 
  labs(
    x = "", 
    y = "number of delays\n", 
    title = "Newark Airport - number of delayed flights\n"
  ) + 
  theme_grey()
```

```{r}
# average flight delay at Newark Airport
newark_flights_delayed %>% 
  group_by(month_name) %>% 
  summarise(average_delay = mean(dep_delay)) %>% 
  ggplot() +
  aes(x = month_name, y = average_delay) + 
  geom_col(fill = "lightblue") +
  labs(
    x = "", 
    y = "average delay (mins)\n", 
    title = "Newark Airport - average flight delay\n") + 
  theme_grey()
```

*Weather*

```{r}
# capture only newark weather
newark_weather <- weather_data %>% 
  filter(origin == "EWR")

colSums(is.na(newark_weather))
```

There are 8,700 weather observations relating to Newark Airport in 2017. Of these, most variables had in excess of 8,500 missing values. Only `wind data` (3 variables) and `visibility` were sufficiently populated to be of use with the rest being discarded. The wind data each had ~600 missing values (less than 7% of the population) whilst `visibility` had only 3 missing values. All the missing values were removed as being immaterial in volume to the population of data.

Despite an extensive internet search I could not find free access to hourly weather data for Newark Airport to supplement the provided data set. 

```{r}
# remove missing values
newark_weather <- newark_weather %>% 
  select(wind_dir, wind_speed, wind_gust, visib, time_hour) %>% 
  drop_na()
```

To investigate the effect of weather on departure delays at Newark Airport we need to combine the data for flight delays at the airport with the corresponding weather data. 

As an initial investigation, I will look to determine if we can explain the scale of flight delay (dependent variable) by the weather conditions (independent variables) prevalent at the time. We will use linear regression to determine if there is a direct relationship between the weather data and the length of flight delay. If so we will be able to quantify the size and strength of this relationship. 
To do begin this process we need only the departure delay (`dep_delay`) from the `newark_flights_delayed` dataset combined with the reamining weather data, joined by the date and hour field (`time_hour`).

```{r}
newark_weather_delays <- newark_flights_delayed %>% 
  select(dep_delay, time_hour) %>% 
  inner_join(newark_weather, by = "time_hour") %>% 
  select(-time_hour)
```

The result is a dataset of 41,296 observations with 5 variables. 

```{r}
glimpse(newark_weather_delays)
```
```{r, message=FALSE}
newark_weather_delays %>% 
  gather() %>% 
  ggplot() +
  geom_histogram(mapping = aes(x = value, fill = key), colour = "black") +
  facet_wrap(~ key, scales = "free") + 
  theme_minimal()
```
The dependent variable (`dep_delay`) is very right-skewed. Normally this may prove problematic for use within linear regression but these values are to be expected. Most scheduled airline flights take off on-time or if delayed, the delay is not excessive, so we would expect most delays to be at the lower end of the scale. Interestingly, `wind_gust` and `wind_speed` are similarly right-skewed and so may prove to have a strong relationship with `dep_delay`.

Visibility (`visib`) is very left-skewed with the vast majority of observations providing a clear sight for 10 miles. Wind direction (`wind_dir`) is the most normally distributed of all weather variables. 

*Correlation*

Correlation measures the strength and direction of the relationship between two linearly related variables (meaning they change together at a constant rate).  

The table below shows the 5 variables from our data set and the correlation coefficients that exist between them. 

A positive value indicates that two variables will move in the same direction as each other. As one increases in value, so does the other. A negative value indicates their values will move in opposite directions. The correlation coefficient has a value in the range -1 to +1 where +/- 1 indicates the strongest possible relationship and 0 indicates no relationship. 

Looking at the `dep_delay` column we can see that the relationship between delays and weather events are very weakly correlated indeed.  

```{r}
cor(newark_weather_delays[, c("dep_delay", "wind_dir", "wind_speed", "wind_gust", "visib")])
```

*Fitting the multiple linear regression model*

The following command fits a linear regression model that relates the 4 independent/predictor variables from our dataset to the total departure delay (`dep_delay`), the dependent/reponse variable.

```{r}
weather_delays_mod1 <- lm(data = newark_weather_delays, dep_delay ~ .)
```

To evaluate how well the model fits our data and how well it explains the values of the dependent variable, we run the `summary` command. 

```{r}
summary(weather_delays_mod1)
```

*Model evaluation*

The regression coefficients (under the `Estimate` column) indicate the estimated change in value in departure delays for a one unit change in each of the predictor variables, assuming all other values are held constant. 

From the available weather dataset, visibility (`visib`) impacts departure delays the most. For each additional mile of visibility, departure delays will reduce by just over 2 minutes. 

The wind variables (`wind_dir` and `wind_speed`) have very little impact on departure delays whilst `wind_gust` has a `NA` value. This indicates it is linearly related to the other wind variables and should be removed from the model.

The `residuals` provide a measure of the error in our model predictions - the residual is equal to the true value less the model predicted value. The maximum error of 1163.56 shows that linear regression under-predicted the departure delay by over 19 hours (19 x 60 mins = 1,140) for at least one observation. This is quite substantial. 

Each of the weather variables has a very small `p-value` denoted by Pr(>|t|) and all are statistically significant, indicated by the 3-stars (***). This indicates that the coefficients are indicative of true relationship, rather than just occuring by chance.  

Towards the bottom of the summary table, the Multiple R-squared value provides a measure of how well our model of weather data explains the movement in departure delays. Similar to the correlation coefficient, the closer the R-squared value is to 1.0, the better the model explains the data. Since our model has an R-squared value of 0.00629, this informs us that the model is a very poor predictor as it explains only 0.67% of movement in departure delays. 

Given the above indicators, it is clear that weather has little impact on departure delays at Newark Airport. 










