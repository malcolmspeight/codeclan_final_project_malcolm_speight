---
title: "Newark Flight Data"
author: "Malcolm Speight"
date: "2023-02-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r, include=FALSE}
library(tidyverse)
library(lubridate)
library(ggfortify)
```

```{r, include=FALSE}
flights_data <- read_csv("data/flights.csv") %>% 
  janitor::clean_names()
airports_data <- read_csv("data/airports.csv") %>% 
  janitor::clean_names()
weather_data <- read_csv("data/weather.csv") %>% 
  janitor::clean_names()
plane_data <- read_csv("data/planes.csv") %>% 
  janitor::clean_names()
```

```{r}
# capture only newark airport flights
newark_flights <- inner_join(flights_data, airports_data, by = c("origin" = "faa")) %>% 
  filter(name == "Newark Liberty International Airport") %>% 
  mutate(date = make_date(year, month, day)) %>% # add date field
  mutate(month_name = month(date, label = TRUE)) # add month name
```

```{r}
# missing values in newark flights data
colSums(is.na(newark_flights))
```



```{r}
# categorise delay times
# delays less than 15 mins are "on time" according to FAA
newark_flights_delayed <- newark_flights %>% 
  filter(dep_delay > 0) %>% 
  mutate(delay_category = case_when(
    dep_delay > 60 ~ "delays > 1 hr", 
    dep_delay >= 15 ~ "delays <= 1hr", 
    TRUE ~ "delays < 15 mins"
  ))
```


```{r}
# number of delayed flights at Newark Airport
newark_flights_delayed %>% 
  group_by(month_name) %>%
  summarise(num_delays = n()) %>% 
  ggplot() +
  aes(x = month_name, y = num_delays) +
  geom_col(fill = "lightblue") + 
  labs(
    x = "", 
    y = "number of delays\n", 
    title = "Newark Airport - number of delayed flights\n"
  ) + 
  theme_grey()
```

```{r}
# average flight delay at Newark Airport
newark_flights_delayed %>% 
  group_by(month_name) %>% 
  summarise(average_delay = mean(dep_delay)) %>% 
  ggplot() +
  aes(x = month_name, y = average_delay) + 
  geom_col(fill = "lightblue") +
  labs(
    x = "", 
    y = "average delay (mins)\n", 
    title = "Newark Airport - average flight delay\n") + 
  theme_grey()
```

*Weather*

```{r}
# capture only newark weather
newark_weather <- weather_data %>% 
  filter(origin == "EWR")

colSums(is.na(newark_weather))
```

There are 8,700 weather observations relating to Newark Airport in 2017. Of these, most variables had in excess of 8,500 missing values. Only `wind data` (3 variables) and `visibility` were sufficiently populated to be of use with the rest being discarded. The wind data each had ~600 missing values (less than 7% of the population) whilst `visibility` had only 3 missing values. All the missing values were removed as being immaterial in volume to the population of data.

Despite an extensive internet search I could not find free access to hourly weather data for Newark Airport to supplement the provided data set. 

```{r}
# remove missing values
newark_weather_tidy <- newark_weather %>% 
  select(wind_dir, wind_speed, wind_gust, visib, time_hour) %>% 
  drop_na()
```

To investigate the effect of weather on departure delays at Newark Airport we need to combine the data for flight delays at the airport with the corresponding weather data. 

As an initial investigation, I will look to determine if we can explain the scale of flight delay (dependent variable) by the weather conditions (independent variables) prevalent at the time. We will use linear regression to determine if there is a direct relationship between the weather data and the length of flight delay. If so we will be able to quantify the size and strength of this relationship. 
To do begin this process we need only the departure delay (`dep_delay`) from the `newark_flights_delayed` dataset combined with the reamining weather data, joined by the date and hour field (`time_hour`).

```{r}
newark_weather_delays <- newark_flights_delayed %>% 
  select(dep_delay, time_hour) %>% 
  inner_join(newark_weather_tidy, by = "time_hour") 
```

The result is a dataset of 41,296 observations with 5 numeric variables. 

```{r}
glimpse(newark_weather_delays)
```

```{r, message=FALSE}
newark_weather_delays %>% 
  select(-time_hour) %>% # remove time stamp
  gather() %>% 
  ggplot() +
  geom_histogram(mapping = aes(x = value, fill = key), colour = "black") +
  facet_wrap(~ key, scales = "free") + 
  theme_minimal()
```

The dependent variable (`dep_delay`) is very right-skewed. Most scheduled airline flights take off on-time or if delayed, the delay is not excessive, so we would expect most delays to be at the lower end of the scale. Interestingly, `wind_gust` and `wind_speed` are similarly right-skewed.

Visibility (`visib`) is very left-skewed with the vast majority of observations providing a clear sight for 10 miles. Wind direction (`wind_dir`) is the most normally distributed of all the weather variables. 

The skewness of the variables can be lessened by log transforming the data. I'll look to log transform all of the independent variables except for `wind_dir` which as noted above has a fairly normal distribution. 

```{r}
newark_weather_delays_log <- newark_weather_delays %>% 
  mutate(visib_log = log(visib),
         wind_gust_log = log(wind_gust + 1), # to avoid -Infinity
         wind_speed_log = log(wind_speed + 1)) %>% # to avoid -Infinity
  select(-c("visib", "wind_gust", "wind_speed", "time_hour")) 
```

```{r, message=FALSE, warning=FALSE}
newark_weather_delays_log %>% 
  gather() %>% 
  ggplot() +
  geom_histogram(mapping = aes(x = value, fill = key), colour = "black") +
  facet_wrap(~ key, scales = "free") + 
  theme_minimal()
```
The log of the visibility variable remains skewed left but `wind_gust` and `wind_speed` appear more normally distributed than prior to transformation.

*Correlation*

Correlation measures the strength and direction of the relationship between two linearly related variables (meaning they change together at a constant rate).  

The table below shows the 5 variables from our data set and the correlation coefficients that exist between them. 

A positive value indicates that two variables will move in the same direction as each other. As one increases in value, so does the other. A negative value indicates their values will move in opposite directions. The correlation coefficient has a value in the range -1 to +1 where +/- 1 indicates the strongest possible relationship and 0 indicates no relationship. 

Looking at the `dep_delay` column we can see that the relationship between delays and weather events are very weakly correlated indeed.  

```{r}
cor(newark_weather_delays_log[, c("dep_delay", "wind_dir", 
                                  "wind_speed_log", "wind_gust_log", "visib_log")])
```

*Linear regression*

The following command fits a linear regression model that relates the 4 independent/predictor variables from our dataset to the total departure delay (`dep_delay`), the dependent/reponse variable.

```{r}
weather_delays_mod1 <- lm(data = newark_weather_delays_log, dep_delay ~ .)
```

To evaluate how well the model fits our data and how well it explains the values of the dependent variable, we run the `summary` command. 

```{r}
summary(weather_delays_mod1)
```

*Model evaluation*

The `residuals` provide a measure of the error in our model predictions - the residual is equal to the true value less the model predicted value. The maximum error of 1162.97 shows that linear regression under-predicted the departure delay by over 19 hours (19 x 60 mins = 1,140) for at least one observation. This is quite substantial. 

The log of the `wind_dir` and `visib` variables both have a very small `p-value` denoted by Pr(>|t|) and are statistically significant, indicated by the 3-stars (***). This indicates that their coefficients are indicative of a true relationship, rather than just occuring by chance. This is not the case for the log of `wind_gust` or `wind_speed` indicating that these variables can be ignored and removed from the model. 

The regression coefficients (under the `Estimate` column) indicate the estimated change in value in departure delays for a one unit change in each of the predictor variables, assuming all other values are held constant. 

Of the statistically significant variables from the weather dataset, visibility impacts departure delays the most. For each additional increment in the log of `visib`, departure delays will decrease by just over 9 minutes. 

Towards the bottom of the summary table, the Multiple R-squared value provides a measure of how well our model of weather data explains the movement in departure delays. Similar to the correlation coefficient, the closer the R-squared value is to 1.0, the better the model explains the data. Since our model has an R-squared value of 0.00583, this informs us that the model is a very poor predictor as it explains only 0.58% of movement in departure delays. 

From the above indicators, it would appear that weather events have little impact on departure delays at Newark Airport. 

*Validity of regression model*

Assessing the validity of the linear regression requires that:

1. The errors of the model (residuals) are independent of each other.
  - the blue line in the Residuals vs Fitted graph below shows that this condition is true. 

2. The residuals are normally distributed. 
  - the Normal Q-Q plot shows the data points diverging from the dotted line as values increase, highlighting that this assumption may not be satisfied.  
  
3. There is no systematic increase or decrease in variation across the range of data
  - the data points should occur in a fixed width band in the Scale-Location plot. This doesn't appear to hold as the data points funnel towards a point as the fitted values rise in value. 

```{r}
autoplot(weather_delays_mod1)
```

It would appear that a linear regression produces a poor explanation for the movement in departure delays and the residuals from which may not satisfy required conditions for the model to hold. Given these issues it may instead be best to consider if we can classify combinations of the weather variables as indicative of a `delay` or `no-delay` at Newark Airport. 


*Logistic regression*

Attempting to define a linear regression model for delays and weather data proved inconclusive. Linear regression is suited to addressing dependent variables that have continuous values. However, the delay associated with a plane departing an airport can be seen not to have a linear relationship to a series of variables as their impact on delay is changeable and dependent on many other factors or a combination of factors. In such circumstances it is clearly better to categorise our dependent variable, to begin with at least, as having two values: `delay` or `no-delay`.  

**Weather related delays**

_Flight data_
Let's return to the beginning and refresh our data so that we can start with a clean slate. 

Flights leaving Newark Airport can be extracted from the main flights dataset (`flights_data`) after joining with `airports_data` and filtering on Newark Airport. 

```{r}
# capture only newark airport flights
newark_flights <- inner_join(flights_data, airports_data, by = c("origin" = "faa")) %>% 
  filter(name == "Newark Liberty International Airport") 
```

The `newark_flights` data contains 26 variables with 115,968 observations. 

```{r}
glimpse(newark_flights)
```

Some of the data is superfluous and is repeated for each entry so we can remove details of Newark Airport such as the `name` and `latitude` and `longitude` and the like. 

```{r}
newark_flights <- newark_flights %>% 
  select(-c(name, lat, lon, alt, tz, dst, tzone, origin))
```

There are a number of missing values across the dataset. 

```{r}
colSums(is.na(newark_flights))
```
Of these only `tailnum` is a character data type. All the other are numeric. Dealing with the numeric first, we start by looking at the summary statistics. 

```{r}
newark_flights %>% 
  keep(is.numeric) %>% 
  summary()
```
For `dep_time`, `dep_delay`, `arr_time`, `arr_delay` we can use mean imputation to resolve the missing values. 

```{r}
newark_flights_clean <- newark_flights %>% 
  mutate(dep_time = coalesce(dep_time, mean(dep_time, na.rm = TRUE)), 
         dep_delay = coalesce(dep_delay, mean(dep_delay, na.rm = TRUE)), 
         arr_time = coalesce(arr_time, mean(arr_time, na.rm = TRUE)), 
         arr_delay = coalesce(arr_delay, mean(arr_delay, na.rm = TRUE)))
```

The summary statistics should for these variables should remain similar to that prior to adjustment, as is the case here.  

```{r}
newark_flights_clean %>% 
  select(dep_time, dep_delay, arr_time, arr_delay) %>% 
  summary()
```
The remaining numerical variable, `air_time` has a considerable number of missing values. These could be considered erroneous but more likely they indicate that the flight has been cancelled. A new variable (`cancelled`) should be added to capture this information then the `NA` values within `air_time` can be reverted to a zero value. 

```{r}
newark_flights_clean <- newark_flights_clean %>% 
  mutate(cancelled_flight = ifelse(is.na(air_time), TRUE, FALSE), .after = air_time) %>% 
  mutate(air_time = coalesce(air_time, 0))
```

The summary statistics are relatively unchanged for air_time whilst the number of `cancelled_flight` TRUE observations matches the previous number of `NA` values within `air_time`

```{r}
newark_flights_clean %>% 
  select(cancelled_flight, air_time) %>% 
  summary()
```
For the remaining `tailnum` variable, I'll replace missing values with "ABCXYZ".

```{r}
newark_flights_clean <- newark_flights_clean %>% 
  mutate(tailnum = ifelse(is.na(tailnum), "ABCXYZ", tailnum))
```

There should now be no missing values within the newark_flights_clean dataset with the loss of no data. 

```{r}
colSums(is.na(newark_flights_clean))
```

And there are still 115,968 observations and we have added a `cancelled_flight` variable.

```{r}
dim(newark_flights_clean)
```

_Dependent variable_

There is currently no dependent variable (class) in the dataset so we should add one. Newark Airport are interested in departure delays. Although the US aviation authority (The FAA) state that flights departing with less than a 15 minute delay are deemed to be 'on time', we will classify all flights with a departure delay of greater than 0 as being delayed. 

```{r}
# add dependent variable
newark_flights_clean <- newark_flights_clean %>% 
  mutate(delayed = ifelse(dep_delay > 0, TRUE, FALSE), .after = dep_delay)
```


_Weather data_

As with the flights data from Newark, let's also refresh the weather data. 

```{r}
# capture only newark weather
newark_weather <- weather_data %>% 
  filter(origin == "EWR")
```

The newark weather data contains 15 variables with 8,735 observations. 

```{r}
glimpse(newark_weather)
```

As previously stated, despite an extensive internet search I could not find free access to hourly weather data for Newark Airport to supplement the provided data set. 

There are a number of missing values across the weather dataset. 

```{r}
colSums(is.na(newark_weather))
```
All of these variables are numeric. We start by looking at the summary statistics. 

```{r}
newark_weather %>% 
  keep(is.numeric) %>% 
  summary()
```

The following variables have so many missing entries that it makes no sense to impute values for them and they should just be removed from the dataset: `temp`, `dewp`, `humid`, `precip` and `pressure`. In addition, `origin` should also be removed as it is superfluous information. 

```{r}
newark_weather_clean <- newark_weather %>% 
  select(-c(temp, dewp, humid, precip, pressure, origin))
```

The remaining missing values should be imputed with mean values.

```{r}
newark_weather_clean <- newark_weather_clean %>% 
  mutate(wind_dir = coalesce(wind_dir, mean(wind_dir, na.rm = TRUE)), 
         wind_speed = coalesce(wind_speed, mean(wind_speed, na.rm = TRUE)),
         wind_gust = coalesce(wind_gust, mean(wind_gust, na.rm = TRUE)),
         visib = coalesce(visib, mean(visib, na.rm = TRUE)))
```

The summary statistics should remain relatively unchanged for these variables, which they do.  

```{r}
newark_weather_clean %>% 
  select(wind_dir, wind_speed, wind_gust, visib) %>% 
  summary()
```
There are now no missing values within the newark_weather dataset. 

```{r}
colSums(is.na(newark_weather_clean))
```
For the retained variables there has been no loss of data - there are still 8,735 observations. 

```{r}
dim(newark_weather_clean)
```

_Weather delays_



































